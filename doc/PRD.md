# Gitie 项目增强功能产品需求文档 (PRD)

## 1. 概述

### 1.1 背景

Gitie 是一个基于 AI 的 Git 增强工具，目前主要能够利用大型语言模型 (LLM) 自动生成 commit 信息。当前版本通过分析 git diff 信息来生成提交消息，但缺乏对代码结构和上下文的深入理解。为了提高 commit 信息的质量和精确度，我们计划引入 tree-sitter 来解析代码语法树，从而使 AI 能够更好地理解代码变更的语义和结构。

### 1.2 项目目标

1. 通过 tree-sitter 获取项目代码的语法树结构，实现对代码的深入理解
2. 分析 git diff 对整个代码库语法树的影响，精确定位变更点及其上下文
3. 结合语法树分析与 git diff 信息，通过 LLM 生成更精准、语义化的 commit 信息
4. 保持与现有 Git 工作流的无缝集成

### 1.3 用户价值

1. 提高 commit 信息的质量和准确性，使其更好地反映代码变更的实际含义
2. 减少开发者编写详细 commit 信息的时间
3. 通过对代码结构的理解，帮助开发者更好地追踪和理解代码变更历史
4. 改善团队协作，使其他开发者能更快理解代码变更的意图和影响

## 2. 功能需求

### 2.1 基于 tree-sitter 的语法树解析

#### 2.1.1 多语言支持
- 支持解析常见编程语言的语法树，包括但不限于：
  - Rust
  - JavaScript/TypeScript
  - Python
  - Java
  - C/C++
  - Go

#### 2.1.2 项目语法树缓存
- 首次分析时构建完整项目语法树
- 增量更新缓存的语法树，避免重复解析未变更的文件
- 定期（或在特定触发条件下）重新构建完整语法树以确保准确性

#### 2.1.3 语法树访问接口
- 提供 API 用于查询和遍历语法树
- 支持按文件、模块、函数等单位访问语法树节点
- 支持结构化查询语言 (SQI) 以便于提取特定的语法结构

### 2.2 Git diff 与语法树集成

#### 2.2.1 差异映射
- 将 git diff 信息映射到语法树的相应节点
- 识别被修改的语法结构（如函数、类、方法等）
- 追踪语法结构的变更（如重命名、移动、重构等）

#### 2.2.2 变更影响分析
- 分析代码变更对依赖关系的影响
- 检测潜在的 API 变更或接口修改
- 识别重要的结构性变更（如添加新类、删除方法等）

#### 2.2.3 变更分类
- 根据变更类型对修改进行分类（如功能添加、bug 修复、重构等）
- 识别变更的复杂度和范围（如单文件修改、跨模块变更等）
- 检测特殊操作（如依赖更新、配置修改等）

### 2.3 增强的 AI 提交信息生成

#### 2.3.1 上下文感知的消息生成
- 将语法树分析结果与 git diff 信息一起提供给 LLM
- 构建更丰富的提示模板，包含变更的上下文、影响和结构信息
- 优化 AI 模型的输入格式，使其能更好地理解代码变更的语义

#### 2.3.2 定制化输出格式
- 支持多种 commit 消息风格（如 Conventional Commits、Angular 等）
- 允许用户定制 commit 消息的输出格式和内容
- 支持多语言 commit 信息（如中文、英文等）

#### 2.3.3 多级别详细程度
- 提供简要 commit 信息用于标题
- 生成详细的 commit 描述，包含变更的影响和背景
- 可选地生成技术性说明，详述实现细节

### 2.4 用户体验增强

#### 2.4.1 配置灵活性
- 提供可配置的语法树解析深度和范围
- 允许用户指定关注的文件类型和代码结构
- 支持通过配置文件或命令行参数进行设置

#### 2.4.2 性能优化
- 实现语法树的增量更新，减少解析时间
- 优化内存使用，避免大型项目中的性能问题
- 支持后台处理，减少用户等待时间

#### 2.4.3 交互式体验
- 允许用户在生成的 commit 信息基础上进行修改
- 提供可视化的语法树和变更影响图（可选功能）
- 用户反馈机制，用于不断改进 AI 生成的质量

## 3. 技术要求

### 3.1 Tree-sitter 集成

- 使用 Rust 的 tree-sitter 绑定
- 支持动态加载各种语言的 tree-sitter 解析器
- 开发语法树缓存和增量更新机制

### 3.2 Git 集成

- 解析和处理 git diff 输出
- 与 Git 命令行工具的无缝集成
- 支持各种 Git 操作场景（如常规提交、合并提交等）

### 3.3 AI 模型集成

- 优化 LLM 提示模板，包含语法树分析结果
- 支持本地和远程 AI 模型
- 处理模型输出，确保符合预期的 commit 消息格式

### 3.4 性能与可扩展性

- 优化大型代码库的语法树解析性能
- 设计可扩展的架构，支持未来添加更多语言和功能
- 实现有效的缓存和增量更新策略

## 4. 用户流程

### 4.1 基本提交流程

1. 用户进行代码修改并暂存更改（`git add`）
2. 用户运行 `gitie commit` 命令
3. Gitie 分析已暂存的变更，构建/更新相关文件的语法树
4. Gitie 确定变更的语法结构和影响范围
5. Gitie 将 diff 信息和语法树分析结果发送给 LLM
6. LLM 生成适当的 commit 信息
7. Gitie 使用生成的信息执行 git commit
8. 向用户显示确认信息

### 4.2 高级用例

#### 4.2.1 代码重构分析
1. 用户进行大规模代码重构
2. Gitie 识别结构性变更（如函数移动、类重命名等）
3. 生成的 commit 信息明确说明重构的目的和影响

#### 4.2.2 多语言项目支持
1. 用户在包含多种编程语言的项目中工作
2. Gitie 为每种语言使用适当的 tree-sitter 解析器
3. 综合分析不同语言文件的变更
4. 生成统一且连贯的 commit 信息

#### 4.2.3 配置变更分析
1. 用户修改项目配置文件
2. Gitie 识别配置变更的性质和影响
3. 生成描述配置变更目的的 commit 信息

## 5. 实现计划

### 5.1 阶段一：基础架构

1. 集成 tree-sitter 库，支持基本语言解析
2. 实现项目语法树的构建和存储
3. 开发 git diff 信息与语法树节点的映射机制

### 5.2 阶段二：核心功能

1. 实现变更影响分析算法
2. 增强 LLM 提示模板，整合语法树分析结果
3. 开发增量语法树更新机制

### 5.3 阶段三：优化与扩展

1. 添加更多语言支持
2. 优化性能和内存使用
3. 增强用户交互体验
4. 实现高级配置选项

## 6. 验收标准

1. 支持至少 5 种主流编程语言的语法树解析
2. 相比基础版本，生成的 commit 信息质量提升至少 30%（通过用户反馈和自动评估）
3. 在包含 10,000+ 行代码的项目中，完整分析时间不超过 5 秒
4. 增量分析时间不超过 1 秒
5. 内存占用合理，不超过基础版本的 2 倍
6. 与现有 Git 工作流保持兼容，不引入额外的使用复杂性

## 7. 未来拓展方向

1. 集成代码质量和安全分析
2. 支持团队协作和代码审查工作流
3. 添加自定义规则以符合特定项目的 commit 规范
4. 开发可视化工具展示代码变更的结构影响
5. 与 CI/CD 管道集成，支持自动化工作流